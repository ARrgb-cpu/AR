name: BeamNG-NoGPU-16GB

on:
  workflow_dispatch:

jobs:
  run-server:
    runs-on: windows-latest # Public repos get 16GB RAM
    steps:
      - name: Install Virtual Display Driver
        run: |
          # Download a driver that emulates a GPU/Monitor
          Invoke-WebRequest "https://github.com/adyusuf/Virtual-Display-Driver/releases/download/v2.0/IddSampleDriver.zip" -OutFile "vdd.zip"
          Expand-Archive vdd.zip -DestinationPath "C:\vdd"
          # NOTE: Manual installation in Device Manager is usually required 
          # but this prepares the files for your RDP session.

      - name: Configure Tailscale
        run: |
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile ts.exe
          Start-Process .\ts.exe -ArgumentList "/quiet" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_KEY }} --hostname=NoGPU-EPYC

      - name: Maintain RDP Session
        run: |
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "Tailscale IP: $ip"
          Write-Host "Username: runneradmin"
          # Keep the 16GB RAM runner alive
          while($true) { Start-Sleep -Seconds 60 }
