name: BeamNG-EPYC-RDP

on:
  workflow_dispatch:

jobs:
  gaming-setup:
    runs-on: windows-latest # Will give 16GB RAM if the repo is PUBLIC
    timeout-minutes: 3600

    steps:
      - name: Create Gaming User
        run: |
          $pass = "BeamNG_EPYC_2026!" | ConvertTo-SecureString -AsPlainText -Force
          New-LocalUser -Name "EPYC_Player" -Password $pass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "EPYC_Player"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "EPYC_Player"

      - name: Bypass GPU Requirement
        run: |
          # Standard RDP fails for gaming because of the lack of a monitor.
          # This registry key helps Windows ignore the "No Monitor" error.
          Write-Host "Configuring Virtual Graphics..."
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' -Name "EnableLUA" -Value 0 -Force

      - name: Setup Tailscale
        run: |
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile ts.exe
          Start-Process .\ts.exe -ArgumentList "/quiet" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_KEY }} --hostname=EPYC-BeamNG

      - name: Connection Info & Keep Alive
        run: |
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "=== CONNECTION READY ==="
          Write-Host "Tailscale IP: $ip"
          Write-Host "User: EPYC_Player"
          Write-Host "Pass: BeamNG_EPYC_2026!"
          Write-Host "========================"
          while($true) { Start-Sleep -Seconds 60 }
