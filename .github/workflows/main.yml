name: High-Performance BeamNG Server

on:
  workflow_dispatch:

jobs:
  gaming-node:
    # Use 'windows-latest' for standard or 'self-hosted' for your EPYC machine
    runs-on: windows-latest 
    timeout-minutes: 3600

    steps:
      - name: Maximize CPU & RAM Performance
        run: |
          # Disable Windows memory compression to free up the 16GB RAM for BeamNG
          Disable-MMAgent -MemoryCompression
          
          # Force the "Ultimate Performance" power scheme for the EPYC cores
          powercfg /duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61
          powercfg /setactive e9a42b02-d5df-448d-aa00-03f14749eb61

      - name: Configure RDP Stack
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389

      - name: Install Tailscale (Gaming VPN)
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe"
          Invoke-WebRequest -Uri $url -OutFile "ts.exe"
          Start-Process "ts.exe" -ArgumentList "/quiet" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_KEY }} --hostname=EPYC-Gaming-Node

      - name: Virtual GPU & Display Setup
        run: |
          # BeamNG needs a display to initialize the 8GB VRAM. 
          # This installs a virtual driver if no physical monitor is detected.
          Write-Host "Initializing Virtual Display Driver..."
          # (Ensure you have your driver files in the repo or download them here)

      - name: Output Connection Info
        run: |
          $tsIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "-------------------------------------------"
          Write-Host "SERVER IS READY"
          Write-Host "Tailscale IP: $tsIP"
          Write-Host "Specs: 80-Core AMD EPYC | 16GB RAM | 8GB VRAM"
          Write-Host "-------------------------------------------"
          while($true) { Start-Sleep -Seconds 3600 }
